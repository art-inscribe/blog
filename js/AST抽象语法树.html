<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AST 抽象语法树 | Y铭的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="个人博客">
    
    <link rel="preload" href="/blog/assets/css/0.styles.d3d2db5e.css" as="style"><link rel="preload" href="/blog/assets/js/app.1f6ff52c.js" as="script"><link rel="preload" href="/blog/assets/js/2.1a90d8d2.js" as="script"><link rel="preload" href="/blog/assets/js/9.e2ea4f18.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ac1d5c45.js"><link rel="prefetch" href="/blog/assets/js/11.b69cfc85.js"><link rel="prefetch" href="/blog/assets/js/12.9d397fda.js"><link rel="prefetch" href="/blog/assets/js/13.e0a39bae.js"><link rel="prefetch" href="/blog/assets/js/14.6fa77682.js"><link rel="prefetch" href="/blog/assets/js/15.a3c75717.js"><link rel="prefetch" href="/blog/assets/js/3.dba40c6f.js"><link rel="prefetch" href="/blog/assets/js/4.d7cd0258.js"><link rel="prefetch" href="/blog/assets/js/5.c1c2b1c5.js"><link rel="prefetch" href="/blog/assets/js/6.a644d090.js"><link rel="prefetch" href="/blog/assets/js/7.e1840d54.js"><link rel="prefetch" href="/blog/assets/js/8.9ac3f109.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.d3d2db5e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/assets/img/logo.jpg" alt="Y铭的博客" class="logo"> <span class="site-name can-hide">Y铭的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/js/" class="nav-link router-link-active">
  js
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="https://www.baidu.com.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  css
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/js/" class="nav-link router-link-active">
  js
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="https://www.baidu.com.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  css
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/js/" aria-current="page" class="sidebar-link">js总结</a></li><li><a href="/blog/js/js常用的数组方法.html" class="sidebar-link">JS中的Array方法</a></li><li><a href="/blog/js/js逻辑运算符.html" class="sidebar-link">js逻辑运算符</a></li><li><a href="/blog/js/AST抽象语法树.html" class="active sidebar-link">AST 抽象语法树</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/js/AST抽象语法树.html#ast-是什么" class="sidebar-link">AST 是什么</a></li><li class="sidebar-sub-header"><a href="/blog/js/AST抽象语法树.html#ast-有什么用" class="sidebar-link">AST 有什么用</a></li><li class="sidebar-sub-header"><a href="/blog/js/AST抽象语法树.html#ast-如何生成" class="sidebar-link">AST 如何生成</a></li><li class="sidebar-sub-header"><a href="/blog/js/AST抽象语法树.html#实战-ast-的运用" class="sidebar-link">实战 AST 的运用</a></li><li class="sidebar-sub-header"><a href="/blog/js/AST抽象语法树.html#总结" class="sidebar-link">总结</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ast-抽象语法树"><a href="#ast-抽象语法树" class="header-anchor">#</a> AST 抽象语法树</h1> <h2 id="ast-是什么"><a href="#ast-是什么" class="header-anchor">#</a> AST 是什么</h2> <p>抽象语法树 (Abstract Syntax Tree)，简称 AST，它是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。</p> <h2 id="ast-有什么用"><a href="#ast-有什么用" class="header-anchor">#</a> AST 有什么用</h2> <p>AST 运用广泛，比如：</p> <ul><li>编辑器的错误提示、代码格式化、代码高亮、代码自动补全；</li> <li>elint、pretiier 对代码错误或风格的检查；</li> <li>webpack 通过 babel 转译 javascript 语法；
并且如果你想了解 js 编译执行的原理，那么你就得了解 AST。</li></ul> <h2 id="ast-如何生成"><a href="#ast-如何生成" class="header-anchor">#</a> AST 如何生成</h2> <p>s 执行的第一步是读取 js 文件中的字符流，然后通过词法分析生成 token，之后再通过语法分析( Parser )生成 AST，最后生成机器码执行。
整个解析过程主要分为以下两个步骤：</p> <ul><li>分词：将整个代码字符串分割成最小语法单元数组</li> <li>语法分析：在分词基础上建立分析语法单元之间的关系
JS Parser 是 js 语法解析器，它可以将 js 源码转成 AST，常见的 Parser 有 esprima、traceur、acorn、shift 等</li></ul> <h3 id="词法分析"><a href="#词法分析" class="header-anchor">#</a> 词法分析</h3> <p>词法分析，也称之为扫描（scanner），简单来说就是调用 next() 方法，一个一个字母的来读取字符，然后与定义好的 JavaScript 关键字符做比较，生成对应的Token。Token 是一个不可分割的最小单元:</p> <blockquote><p>例如 var 这三个字符，它只能作为一个整体，语义上不能再被分解，因此它是一个 Token。</p></blockquote> <p>词法分析器里，每个关键字是一个 Token ，每个标识符是一个 Token，每个操作符是一个 Token，每个标点符号也都是一个 Token。除此之外，还会过滤掉源程序中的注释和空白字符（换行符、空格、制表符等。
最终，整个代码将被分割进一个tokens列表（或者说一维数组）。</p> <h3 id="语法分析"><a href="#语法分析" class="header-anchor">#</a> 语法分析</h3> <p>语法分析会将词法分析出来的 Token 转化成有语法含义的抽象语法树结构。同时，验证语法，语法如果有错的话，抛出语法错误。
说了这么多我们来看下 javaScript 代码片段转成 AST 之后是什么样的我们拿一行简单的代码来展示</p> <h3 id="例子-1"><a href="#例子-1" class="header-anchor">#</a> 例子 1</h3> <p><code>const fn = a =&gt; a;</code></p> <p><img src="https://img-blog.csdnimg.cn/2021042914063084.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzEyODc1MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
如图从这个 AST 语法树我们就能够很清楚的看出一个代码他的具体含义，并且使用的是什么语法，方法等。
用人话翻译这个图就是：用类型 const 声明变量 fn 指向一个箭头函数表达式，它的参数是 a 函数体也是 a。</p> <h3 id="例子-2"><a href="#例子-2" class="header-anchor">#</a> 例子 2</h3> <div class="language- extra-class"><pre class="language-text"><code>const fn = a =&gt; {
	let i = 1;
  return a + i;
};
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/2021042914072668.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzEyODc1MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="例子-3"><a href="#例子-3" class="header-anchor">#</a> 例子 3</h3> <div class="language- extra-class"><pre class="language-text"><code>function test(){
  let a = 1;
  console.log(a)
}
</code></pre></div><p><img src="https://img-blog.csdnimg.cn/20210429140758371.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzEyODc1MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
以上截图均是使用 Acorn 解析。使用 Acorn 的原因是据我了解在 parser 解析中，Acorn 是公认的最快的。并且我们使用的 Webpack 打包工具中 babel 用的也是 Acorn。
上述截图的属性是 AST 的一部分，这个结构包含了很多属性。</p> <ul><li>VariableDeclaration 变量声明</li> <li>VariableDeclarator 变量声明的描述</li> <li>Expression 表达式节点</li></ul> <p>更多属性展示：</p> <ol><li>可以去 AST explorer 可以在线看到不同的 parser 解析 js 代码后得到的 AST。</li> <li>github 上看所有的 ESTree <a href="https://github.com/estree/estree" target="_blank" rel="noopener noreferrer">ESTree<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>关于属性介绍的文档 抽象语法树AST介绍</li></ol> <h2 id="实战-ast-的运用"><a href="#实战-ast-的运用" class="header-anchor">#</a> 实战 AST 的运用</h2> <h3 id="题目"><a href="#题目" class="header-anchor">#</a> 题目</h3> <p>通过上面介绍的 console.log AST，下面我们就来完成一个在调用 console.log(xx) 时候给前面加一个函数名，这样用户在打印时候能改方便看到是哪个函数调用的。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 源代码</span>
<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// --------------------</span>
<span class="token comment">// 转化后代码</span>
<span class="token keyword">function</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;getData&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>介绍
首先介绍下我们需要使用的工具 Babel</p> <ul><li>@babel/parser : 将 js 代码 -------&gt;&gt;&gt;  AST 抽象语法树；</li> <li>@babel/traverse 对 AST 节点进行递归遍历；</li> <li>@babel/types 对具体的 AST 节点进行进行修改；</li> <li>@babel/generator :  AST 抽象语法树 -------&gt;&gt;&gt; 新的 js 代码；
为什么使用 babel ? 主要是比较好用（只对这个比较熟悉😭）。
进入 @babel/parser 官网开头就介绍了它是使用的 Acorn 来解析 js 代码成 AST 语法树（说明确实 Acorn 比较好）。</li></ul> <p><img src="https://img-blog.csdnimg.cn/2021042914111484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzEyODc1MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p> <h3 id="开始码起来"><a href="#开始码起来" class="header-anchor">#</a> 开始码起来</h3> <ol><li>新建文件打开控制台安装需要的包</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>cnpm i @babel<span class="token operator">/</span>parser @babel<span class="token operator">/</span>traverse @babel<span class="token operator">/</span>types @babel<span class="token operator">/</span>generator <span class="token operator">-</span><span class="token constant">D</span>
</code></pre></div><ol start="2"><li>创建 js 文件, 编写大致布局如下 使用 AST</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/generator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.parse 将代码解析为抽象语法树（AST）</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2,traverse 转换代码</span>
  traverse<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. generator 将 AST 转回成代码</span>
  <span class="token keyword">return</span> generator<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
function getData() {
  console.log(&quot;data&quot;)
}
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newCode <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</code></pre></div><p>使用 node 跑出结果，因为什么都没处理，输出的是原代码
<img src="https://img-blog.csdnimg.cn/20210429141217819.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzEyODc1MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
完善 compile 方法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.parse</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2,traverse</span>
  <span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到 callee 数据</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> callee <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
      <span class="token comment">// 判断是否是调用了 console.log 方法</span>
      <span class="token comment">// 1. 判断是否是成员表达式节点，上面截图有详细介绍</span>
      <span class="token comment">// 2. 判断是否是 console 对象</span>
      <span class="token comment">// 3. 判断对象的属性是否是 log</span>
      <span class="token keyword">const</span> isConsoleLog <span class="token operator">=</span>
        types<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>callee<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;console&quot;</span> <span class="token operator">&amp;&amp;</span>
        callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;log&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isConsoleLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果是 console.log 的调用 找到上一个父节点是函数</span>
        <span class="token keyword">const</span> funcPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">isFunctionDeclaration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取函数的名称</span>
        <span class="token keyword">const</span> funcName <span class="token operator">=</span> funcPath<span class="token punctuation">.</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token comment">// 将名称通过 types 来放到函数的参数前面去</span>
        path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>funcName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// traverse 转换代码</span>
  traverse<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. generator 将 AST 转回成代码</span>
  <span class="token keyword">return</span> generator<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>纯代码看起来比较难理解下面是我将上面的 path.node 写入到文件中给大家看下数据格式。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CallExpression&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
  <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">43</span><span class="token punctuation">,</span>
  <span class="token string">&quot;loc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">21</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;callee&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MemberExpression&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
    <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span>
    <span class="token string">&quot;loc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;object&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
      <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span>
      <span class="token string">&quot;loc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;identifierName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;console&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;property&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
      <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">,</span>
      <span class="token string">&quot;loc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">13</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;identifierName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;log&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;computed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;arguments&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;StringLiteral&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">36</span><span class="token punctuation">,</span>
      <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span>
      <span class="token string">&quot;loc&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;end&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;line&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;column&quot;</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;rawValue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'data'&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;data&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们将不必要的位置信息（start, end, loc）属性删除，对照数据来看代码将会一目了然
<img src="https://img-blog.csdnimg.cn/20210429141321274.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzEyODc1MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> <img src="https://img-blog.csdnimg.cn/20210429141332543.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzEyODc1MQ==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
很好，调用 console.log 方法参数前面增加了函数名，完成！！
为了大家能够方便运行，下面是完整代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> generator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/generator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/traverse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.parse</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2,traverse</span>
  <span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> callee <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
      <span class="token keyword">const</span> isConsoleLog <span class="token operator">=</span>
        types<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>callee<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;console&quot;</span> <span class="token operator">&amp;&amp;</span>
        callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;log&quot;</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isConsoleLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> funcPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">isFunctionDeclaration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> funcName <span class="token operator">=</span> funcPath<span class="token punctuation">.</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./funcPath.json&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>funcPath<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;写入成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>funcName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  traverse<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> visitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. generator</span>
  <span class="token keyword">return</span> generator<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
function getData() {
  console.log('data')
}
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">compile</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>为了兼容低版本浏览器 我们也通常会使用 webpack 打包编译我们的代码将 ES6 语法降低版本，比如箭头函数变成普通函数。将 const、let 声明改成 var 等等，他都是通过 AST 来完成的，只不过实现的过程比较复杂，精致。不过也都是这三板斧：</p> <ol><li>js 语法解析成 AST；</li> <li>修改 AST；</li> <li>AST 转成 js 语法</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/js/js逻辑运算符.html" class="prev">
        js逻辑运算符
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.1f6ff52c.js" defer></script><script src="/blog/assets/js/2.1a90d8d2.js" defer></script><script src="/blog/assets/js/9.e2ea4f18.js" defer></script>
  </body>
</html>
